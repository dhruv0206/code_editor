# # Use a lightweight Python image
# FROM python:3.9-slim

# # Install required packages and nsjail dependencies
# RUN apt-get update && apt-get install -y \
#     autoconf \
#     bison \
#     flex \
#     gcc \
#     g++ \
#     git \
#     libprotobuf-dev \
#     libnl-route-3-dev \
#     libtool \
#     make \
#     pkg-config \
#     protobuf-compiler \
#     python3-pip \
#     && apt-get clean \
#     && rm -rf /var/lib/apt/lists/*

# # Clone and build nsjail
# RUN git clone https://github.com/google/nsjail.git /nsjail \
#     && cd /nsjail \
#     && make -j8 \
#     && cp /nsjail/nsjail /bin \
#     && rm -rf /nsjail

# # Install required Python packages
# COPY requirements.txt /app/
# RUN pip install --no-cache-dir -r /app/requirements.txt

# # Copy application code and configuration
# COPY app.py nsjail.config.proto /app/

# # Set working directory
# WORKDIR /app

# # Create required directories
# RUN mkdir -p /tmp

# # Test nsjail directly
# RUN nsjail --help || echo "nsjail installation issue"

# # Expose port
# EXPOSE 8080

# # Run the application with debug mode
# CMD ["python", "-u", "app.py"]




# Use a lightweight Python image
FROM python:3.9-slim

# Install required packages and nsjail dependencies
RUN apt-get update && apt-get install -y \
    autoconf \
    bison \
    flex \
    gcc \
    g++ \
    git \
    libprotobuf-dev \
    libnl-route-3-dev \
    libtool \
    make \
    pkg-config \
    protobuf-compiler \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Clone and build nsjail
RUN git clone https://github.com/google/nsjail.git /nsjail \
    && cd /nsjail \
    && make -j8 \
    && cp /nsjail/nsjail /bin \
    && rm -rf /nsjail

# Verify nsjail installation
RUN nsjail --help | head -1

# Install required Python packages
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r /app/requirements.txt

# Copy application code and configuration
COPY app.py nsjail.config.proto /app/

# Set working directory
WORKDIR /app

# Expose port
EXPOSE 8080

# Run the application
CMD ["python", "app.py"]